#!/bin/bash
SRC_DIR=${PROJECT_SOURCE_DIR}
BUILD_DIR=${PROJECT_BINARY_DIR}
WISH=wish-shell.tgz
PLIST_BUDDY=/usr/libexec/PlistBuddy

function set_plist() {
    $PLIST_BUDDY -c "Delete $1 string $2" $3
    $PLIST_BUDDY -c "Add $1 string $2" $3
}

PD_APP=$(basename ${BUNDLE})
PD_CONTENT=$BUILD_DIR/dist/$PD_APP/Contents
PD_RESOURCES=$PD_CONTENT/Resources
PD_BIN=$PD_RESOURCES/bin

PD_INFO="$BUILD_DIR/Info.plist"
PD_ICON="$SRC_DIR/mac/stuff/pd.icns"
PD_ICON_FILE="$SRC_DIR/mac/stuff/pd-file.icns"

cd "$BUILD_DIR"
mkdir -p dist
cd dist
echo "Unpacking Wish Shell"
cp "$SRC_DIR/mac/stuff/$WISH" .
tar xf $WISH

rm -rf $PD_APP
mv "Wish Shell.app" $PD_APP
echo "Copy Wish Shell to $PD_APP"
cd "$PD_APP/Contents"

echo "Copying Info.plist..."
rm -f Info.plist
VERSION=$(git -C $SRC_DIR describe --abbrev=0 --tags| tr - .)
echo "Fixing version to: $VERSION"

set_plist ":CFBundleVersion" $VERSION $PD_INFO
set_plist ":CFBundleShortVersionString" $VERSION $PD_INFO
cp -p "$PD_INFO" .


cd MacOS
mv "Wish Shell" Pd
cd ..
cd Resources
rm -f Wish.icns
cp -p "$PD_ICON" "$PD_ICON_FILE" .
mv "Wish Shell.rsrc" Pd.rsrc
mkdir bin

echo "Copying binaries..."
cp "$BUILD_DIR/src/pd" bin
cp "$BUILD_DIR/src/pd-watchdog" bin
cp "$BUILD_DIR/src/pdsend" bin
cp "$BUILD_DIR/src/pdreceive" bin
cp -R "$SRC_DIR/tcl" .
ln -s tcl Scripts

echo "Copying docs..."
cp -R "$SRC_DIR/doc" .
echo "Copying translations..."
mkdir -p po
cp $BUILD_DIR/po/*.msg "$PD_RESOURCES/po"

echo "Copying extensions:"
mkdir -p extra

cp $SRC_DIR/extra/*.pd extra

find $BUILD_DIR/extra -maxdepth 1 -type d | sed 1d | grep -v -i cmake | while read ext_dir
do
    EXT_NAME=$(basename $ext_dir)
    echo "\t$EXT_NAME"
    mkdir extra/$EXT_NAME
    find "$ext_dir" -type f | grep -v -i cmake | grep -v Makefile | while read target
    do
        cp $target extra/$EXT_NAME
    done
#    cp -R "$ext_dir" extra
done

echo "Copying license..."
cp $SRC_DIR/License.txt Scripts

echo "Copying libs..."
NEWLIBPATH="@executable_path/../lib"
EXECFILE="Resources/bin/pd"
LIBDIR="Resources/lib"
cd ..
# to make codesign happy
mkdir -p Frameworks
mkdir -p $LIBDIR
/usr/bin/otool -LX "$EXECFILE" | cut -f2 | cut -d ' ' -f1 | grep -v portmidi | grep -v libSystem | grep -v /System/Library | grep -v CoreFoundation | while read shlib
do
    TARGET=$LIBDIR/$(basename $shlib)
    cp "$shlib" $TARGET
    chown $(whoami) $TARGET
    chmod +w $TARGET

    TARGETID=$(otool -DX $TARGET)
    NEWTARGETID=$NEWLIBPATH/$(basename $shlib)
    echo $NEWTARGETID
    install_name_tool -id $NEWTARGETID $TARGET
    install_name_tool -change $TARGETID $NEWTARGETID $EXECFILE
done

LIBPORTMIDI_NAME=libportmidi.dylib
cp /usr/local/lib/$LIBPORTMIDI_NAME $LIBDIR
LIBPORTMIDI=$LIBDIR/$LIBPORTMIDI_NAME
PM_TARGET="@executable_path/../lib/$LIBPORTMIDI_NAME"
install_name_tool -id $PM_TARGET $LIBPORTMIDI
install_name_tool -change $LIBPORTMIDI_NAME $PM_TARGET $EXECFILE

echo "Copying headers..."
mkdir -p $PD_RESOURCES/include
cp $SRC_DIR/src/m_pd.h $PD_RESOURCES/include

echo "Copying cmake files..."
CMAKE_DIR=$PD_RESOURCES/share/pd/cmake
echo $CMAKE_DIR
mkdir -p $CMAKE_DIR
cp $SRC_DIR/cmake/PdExtension.cmake $CMAKE_DIR

cd ../../..
